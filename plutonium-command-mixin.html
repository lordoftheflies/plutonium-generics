<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer-element.html">
<script>
    (function () {

        'use strict';

        // Create my namespace, if it doesn't exist
        if (!window.Plutonium) {
            window.Plutonium = {};
        }

        Plutonium.CommandEvent = class CommandEvent extends CustomEvent {
            static get is() {
                return 'plutonium-action';
            }

            constructor(name, target, event, args, handler, text, help) {
                super(window.Plutonium.CommandEvent.is, {
                    bubbles: true,
                    composed: true,
                    detail: {
                        name: name,
                        text: text,
                        help: help,
                        target: target,
                        event: event,
                        detail: args,
                        handler: handler
                    }
                });
            }

            get commandHelp() {
                return this.detail.help;
            }

            get commandText() {
                return this.detail.text;
            }

            get commandName() {
                return this.detail.name;
            }

            get commandTarget() {
                return this.detail.target;
            }

            get commandSubject() {
                return this.detail.subject;
            }

            get commandEvent() {
                return this.detail.event;
            }

            get commandArguments() {
                return this.detail.detail;
            }

            get commandHandler() {
                return this.detail.handler;
            }

            attach(hostElement) {
                hostElement.addEventListener(this.commandEvent, this.commandHandler);
            }

            detach(hostElement) {
                hostElement.removeEventListener(this.commandEvent);
            }

            fireGeneric() {
                this.commandTarget.dispatchEvent(new CustomEvent(this.commandEvent, {
                    bubbles: true,
                    composed: true,
                    detail: this.commandArguments
                }));
            }

            toString() {
                return window.Plutonium.CommandEvent.is + '[target=' + this.detail.target + ']';
            }
        };


        /**
         * Element class mixin that provides API for adding navigation to a Polymer 2.0 application.
         *
         * @mixinFunction
         * @polymer
         * @memberof Plutonium
         * @property rootPattern {string} Set default root path for main element.
         * @property page {string} Current page element.
         * @property homePage {string} Homepage, where the base path redirect.
         * @summary Element class mixin that provides API for adding navigation to a Polymer 2.0 application.
         */
        Plutonium.CommandStoreMixin = Polymer.dedupingMixin((base) => class extends base {
                static get properties() {
                    return {
                        actions: {
                            type: Array,
                            compute: 'computeActionList(_map.*)'
                        },
                        _map: {
                            type: Object,
                            notify: true,
                            value: () => {
                            }
                        }
                    };
                }

                connectedCallback() {
                    super.connectedCallback();
                    this.get('actions').forEach(function callback(commandEvent, index, array) {
                        console.debug('listen to action:', commandEvent.toString());
                        commandEvent.attach(this);
                    }, this);

                }

                disconnectedCallback() {
                    super.disconnectedCallback();
                    this.get('actions').forEach(function callback(currentValue, index, array) {
                        console.debug('unlisten to action:', commandEvent.toString());
                        currentValue.detach(this);
                    }, this);
                }

                declareAction(name, target, event, args, handler, text, help) {
                    let command = window.Plutonium.CommandEvent(name, target, event, args, handler, text, help);
                    this.get('_map')[command.commandName] = command;
                }

                cleanAction(name) {
                    delete this._map[command.commandName];
                }

                computeActionList(changeRecord) {
                    let actionMap = this._map;
                    return Object.keys(actionMap).map(function (key) {
                        return actionMap[key];
                    });
                }
            }
        )
        ;
    })();
</script>